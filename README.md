# lapki-flasher

Модуль загрузчика в составе Lapki IDE. Предоставляет WebSockets-интерфейс для опроса и прошивки совместимых аппаратных платформ.

## Поддерживаемые устройства
 - Arduino Uno (ATmega328P)

## Зависимости

Поддерживаемые ОС:
 - Windows 7 и новее
   - Могут понадобиться драйвера для прошиваемых устройств (например, нестандартных Arduino или в Windows 7).
 - Linux-дистрибутивы с менеджером **Systemd**. 
   - Для компиляции нужен `libusb`.
   - Для опроса устройств используется `udevadm`. Возможна работа с `eudev`, но это не тестировалось.

Также для прошивки потребуется **avrdude**. В Linux достаточно установить утилиту встроенным пакетным менеджером, под Windows предлагается установить [форк от maurisgreuel](https://github.com/mariusgreuel/avrdude), положить в рабочую директорию или PATH.

## Сборка и разработка

Для сборки требуется компилятор Go версии 1.20 и новее. Перейдите в директорию `src` и выполните:

`go build -mod=mod .`

Репозиторий содержит описание пакета для **NixOS**. Для сборки этого пакета выполните `nix-build`, для входа в окружение разработки – `nix-shell`.

## Запуск в качестве сервера

Для размещения загрузчика как сетевого сервиса рекомендуется использовать сервер под управлением Linux-дистрибутива с менеджером **Systemd**.

На текущий момент репозиторий не предоставляет инструментов для развёртывания, но эта задача решается тривиально. 

Самая важная деталь – по умолчанию загрузчик запускается по адресу `localhost:8080`, что делает его недоступным извне, так как основная задача модуля – работа в фоне Lapki IDE. Поэтому при запуске модуля необходимо указать ключ `--address :8080`, и **открыть соответствующий порт** в файрволле.

Пример Systemd-сервиса для запуска загрузчика (путь к загрузчику может быть иной):

```toml
[Unit]
Description=Starts lapki-flasher
After=network-online.target

[Service]
ExecStart=/bin/lapki-flasher --address :8080
User=root
Type=simple
Restart=always
RestartSec=3
TimeoutStopSec=5
```

Альтернативно, можно разместить загрузчик за HTTP-сервером по типу **nginx**, но при этом следует настроить [проксирование WebSocket-канала](http://nginx.org/en/docs/http/websocket.html).
